From 9a91c381583ae5b6608d5fc7bbdb60d3f1559486 Mon Sep 17 00:00:00 2001
From: Kaiser <kaiserlancelot123@gmail.com>
Date: Mon, 4 Apr 2022 10:48:03 +0800
Subject: [PATCH] Reduce compile time

---
 include/simdjson/common_defs.h | 11 ++++++++++-
 singleheader/simdjson.h        | 11 ++++++++++-
 2 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/include/simdjson/common_defs.h b/include/simdjson/common_defs.h
index 51210e1..a71a4dd 100644
--- a/include/simdjson/common_defs.h
+++ b/include/simdjson/common_defs.h
@@ -107,7 +107,16 @@ constexpr size_t DEFAULT_MAX_DEPTH = 1024;
 
 #else // SIMDJSON_REGULAR_VISUAL_STUDIO
 
-  #define simdjson_really_inline inline __attribute__((always_inline))
+  #ifndef __has_feature
+    #define __has_feature(feature) 0
+  #endif
+
+  #if __has_feature(address_sanitizer) || defined(__SANITIZE_ADDRESS__)
+    #define simdjson_really_inline inline
+  #else
+    #define simdjson_really_inline inline __attribute__((always_inline))
+  #endif
+
   #define simdjson_never_inline inline __attribute__((noinline))
 
   #define simdjson_unused __attribute__((unused))
diff --git a/singleheader/simdjson.h b/singleheader/simdjson.h
index 026b6f1..64b92d4 100644
--- a/singleheader/simdjson.h
+++ b/singleheader/simdjson.h
@@ -371,7 +371,16 @@ constexpr size_t DEFAULT_MAX_DEPTH = 1024;
 
 #else // SIMDJSON_REGULAR_VISUAL_STUDIO
 
-  #define simdjson_really_inline inline __attribute__((always_inline))
+  #ifndef __has_feature
+    #define __has_feature(feature) 0
+  #endif
+
+  #if __has_feature(address_sanitizer) || defined(__SANITIZE_ADDRESS__)
+    #define simdjson_really_inline inline
+  #else
+    #define simdjson_really_inline inline __attribute__((always_inline))
+  #endif
+
   #define simdjson_never_inline inline __attribute__((noinline))
 
   #define simdjson_unused __attribute__((unused))
-- 
2.32.0

