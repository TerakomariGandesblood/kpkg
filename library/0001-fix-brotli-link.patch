From d386e175d74d1a07109513db39611f66c5c6b5c1 Mon Sep 17 00:00:00 2001
From: Kaiser <1244713586@qq.com>
Date: Sat, 19 Mar 2022 17:56:32 +0800
Subject: [PATCH] fix brotli link

---
 CMakeLists.txt | 26 ++++++++------------------
 1 file changed, 8 insertions(+), 18 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index ecfbb83..aafccec 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -7,7 +7,7 @@
 # several CI services, such as Travis and Drone, use it.  Solaris 11
 # has 2.8.6, and it's not difficult to support if you already have to
 # support 2.8.7.
-cmake_minimum_required(VERSION 2.8.6)
+cmake_minimum_required(VERSION 3.18)
 
 project(woff2)
 
@@ -15,7 +15,6 @@ include(GNUInstallDirs)
 
 # Build options
 option(BUILD_SHARED_LIBS "Build shared libraries" ON)
-option(CANONICAL_PREFIXES "Canonical prefixes" OFF)
 option(NOISY_LOGGING "Noisy logging" ON)
 
 # Version information
@@ -32,20 +31,12 @@ if ("${isSystemDir}" STREQUAL "-1")
 endif()
 
 # Find Brotli dependencies
-set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake")
-find_package(BrotliDec)
-if (NOT BROTLIDEC_FOUND)
-    message(FATAL_ERROR "librotlidec is needed to build woff2.")
-endif ()
-find_package(BrotliEnc)
-if (NOT BROTLIENC_FOUND)
-    message(FATAL_ERROR "librotlienc is needed to build woff2.")
-endif ()
+find_package(PkgConfig REQUIRED)
+pkg_check_modules(libbrotlidec REQUIRED IMPORTED_TARGET libbrotlidec)
+pkg_check_modules(libbrotlienc REQUIRED IMPORTED_TARGET libbrotlienc)
+pkg_check_modules(libbrotlicommon REQUIRED IMPORTED_TARGET libbrotlicommon)
 
 # Set compiler flags
-if (NOT CANONICAL_PREFIXES)
-    add_definitions(-no-canonical-prefixes)
-  endif ()
 if (NOISY_LOGGING)
     add_definitions(-DFONT_COMPRESSION_BIN)
 endif ()
@@ -64,8 +55,7 @@ set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${COMMON_FLAG}")
 set(CMAKE_CXX_STANDARD 11)
 
 # Set search path for our private/public headers as well as Brotli headers
-include_directories("src" "include"
-                    "${BROTLIDEC_INCLUDE_DIRS}" "${BROTLIENC_INCLUDE_DIRS}")
+include_directories("src" "include")
 
 # Common part used by decoder and encoder
 add_library(woff2common
@@ -77,7 +67,7 @@ add_library(woff2common
 add_library(woff2dec
             src/woff2_dec.cc
             src/woff2_out.cc)
-target_link_libraries(woff2dec woff2common "${BROTLIDEC_LIBRARIES}")
+target_link_libraries(woff2dec woff2common PkgConfig::libbrotlidec PkgConfig::libbrotlicommon)
 add_executable(woff2_decompress src/woff2_decompress.cc)
 target_link_libraries(woff2_decompress woff2dec)
 
@@ -88,7 +78,7 @@ add_library(woff2enc
             src/normalize.cc
             src/transform.cc
             src/woff2_enc.cc)
-target_link_libraries(woff2enc woff2common "${BROTLIENC_LIBRARIES}")
+target_link_libraries(woff2enc woff2common PkgConfig::libbrotlienc PkgConfig::libbrotlicommon)
 add_executable(woff2_compress src/woff2_compress.cc)
 target_link_libraries(woff2_compress woff2enc)
 
-- 
2.32.0

